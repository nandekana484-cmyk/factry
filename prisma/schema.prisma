generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../data/database.sqlite"
}

// SQLiteはenum型をサポートしていないため、String型を使用
// アプリケーション層で以下の値を使用する：
// DocumentStatus: "draft" | "pending" | "approved"
// ApprovalAction: "submitted" | "approved" | "rejected" | "withdrawn" | "revised"
// UserRole: "admin" | "approver" | "user"

model User {
  id         Int       @id @default(autoincrement())
  name       String
  email      String    @unique(map: "sqlite_autoindex_users_1")
  password   String
  role       String    @default("user") // "admin" | "approver" | "user"
  created_at DateTime  @default(now())

  // リレーション
  createdDocuments      Document[]         @relation("DocumentCreator")
  approvalRequests      ApprovalRequest[]  @relation("ApprovalRequester")
  approvalCheckers      ApprovalRequest[]  @relation("ApprovalChecker")
  approvalApprovers     ApprovalRequest[]  @relation("ApprovalApprover")
  approvalHistories     ApprovalHistory[]
  approvedRevisions     RevisionHistory[]  @relation("RevisionApprovedBy")
  checkedRevisions      RevisionHistory[]  @relation("RevisionCheckedBy")
  createdRevisions      RevisionHistory[]  @relation("RevisionCreatedBy")
  createdTemplates      Template[]         @relation("TemplateCreator")

  @@map("users")
}

model Folder {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   // 管理番号用コード（例: "WI", "MANUAL"）
  parent_id   Int?
  created_at  DateTime @default(now())

  // リレーション
  parent      Folder?     @relation("FolderTree", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    Folder[]    @relation("FolderTree")
  documents   Document[]

  @@map("folders")
}

model Document {
  id                Int      @id @default(autoincrement())
  title             String
  status            String   @default("draft") // "draft" | "checking" | "pending" | "approved"
  creator_id        Int
  template_id       Int?
  folder_id         Int?     // フォルダID（追加）
  management_number String?  // 管理番号（例: "WI-001", "MANUAL-015"）
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // リレーション
  creator           User              @relation("DocumentCreator", fields: [creator_id], references: [id])
  folder            Folder?           @relation(fields: [folder_id], references: [id])
  blocks            DocumentBlock[]
  approvalRequest   ApprovalRequest?
  approvalHistories ApprovalHistory[]
  revisionHistories RevisionHistory[]

  @@map("documents")
}

model DocumentBlock {
  id          Int     @id @default(autoincrement())
  document_id Int
  type        String  // text, title, shape, image, etc.
  content     String  // JSON string
  position_x  Float
  position_y  Float
  width       Float
  height      Float
  sort_order  Int     @default(0)

  // リレーション
  document Document @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("document_blocks")
}

model ApprovalRequest {
  id           Int       @id @default(autoincrement())
  document_id  Int       @unique
  requester_id Int
  checker_id   Int       // 確認者ID（必須）
  approver_id  Int       // 承認者ID
  requested_at DateTime  @default(now())
  checked_at   DateTime? // 確認日時
  comment      String?

  // リレーション
  document  Document @relation(fields: [document_id], references: [id], onDelete: Cascade)
  requester User     @relation("ApprovalRequester", fields: [requester_id], references: [id])
  checker   User     @relation("ApprovalChecker", fields: [checker_id], references: [id])
  approver  User     @relation("ApprovalApprover", fields: [approver_id], references: [id])

  @@map("approval_requests")
}

model ApprovalHistory {
  id          Int      @id @default(autoincrement())
  document_id Int
  user_id     Int
  action      String   // "submitted" | "approved" | "rejected" | "withdrawn" | "revised"
  comment     String?
  created_at  DateTime @default(now())

  // リレーション
  document Document @relation(fields: [document_id], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [user_id], references: [id])

  @@map("approval_history")
}

model RevisionHistory {
  id                Int      @id @default(autoincrement())
  document_id       Int
  management_number String   // 管理番号（例: "A-1", "A-2"）
  revision_symbol   String   // 改定記号（例: "R1", "R2"）
  title             String   // 文書タイトル
  approved_by_id    Int?     // 承認者
  checked_by_id     Int      // 確認者（必須）
  created_by_id     Int      // 改定作業者
  approved_at       DateTime? // 承認日
  created_at        DateTime @default(now())

  // リレーション
  document   Document @relation(fields: [document_id], references: [id], onDelete: Cascade)
  approvedBy User?    @relation("RevisionApprovedBy", fields: [approved_by_id], references: [id])
  checkedBy  User     @relation("RevisionCheckedBy", fields: [checked_by_id], references: [id])
  createdBy  User     @relation("RevisionCreatedBy", fields: [created_by_id], references: [id])

  @@map("revision_history")
}

model Template {
  id          Int      @id @default(autoincrement())
  name        String
  content     String   // JSON文字列（blocks, paper, orientationなど）
  created_by  Int
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // リレーション
  creator User @relation("TemplateCreator", fields: [created_by], references: [id])

  @@map("templates")
}
