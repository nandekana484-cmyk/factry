generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../data/database.sqlite"
}

model User {
  id                Int               @id @default(autoincrement())
  name              String
  email             String            @unique(map: "sqlite_autoindex_users_1")
  password          String
  role              String            @default("user")
  created_at        DateTime          @default(now())
  approvalHistories ApprovalHistory[]
  approvalApprovers ApprovalRequest[] @relation("ApprovalApprover")
  approvalCheckers  ApprovalRequest[] @relation("ApprovalChecker")
  approvalRequests  ApprovalRequest[] @relation("ApprovalRequester")
  createdDocuments  Document[]        @relation("DocumentCreator")
  createdRevisions  RevisionHistory[] @relation("RevisionCreatedBy")
  checkedRevisions  RevisionHistory[] @relation("RevisionCheckedBy")
  approvedRevisions RevisionHistory[] @relation("RevisionApprovedBy")
  createdTemplates  Template[]        @relation("TemplateCreator")

  @@map("users")
}

model Folder {
  id         Int        @id @default(autoincrement())
  name       String
  code       String     @unique
  parent_id  Int?
  created_at DateTime   @default(now())
  documents  Document[]
  parent     Folder?    @relation("FolderTree", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children   Folder[]   @relation("FolderTree")

  @@map("folders")
}

model DocumentType {
  id          Int        @id @default(autoincrement())
  code        String     @unique
  name        String
  description String?
  order       Int        @default(0)
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt
  documents   Document[]

  @@map("document_types")
}

model Document {
  id                Int               @id @default(autoincrement())
  title             String
  status            String            @default("draft")
  creator_id        Int
  template_id       Int?
  folder_id         Int
  document_type_id  Int?
  sequence          Int
  revision          Int               @default(0)
  management_number String?           // 管理番号を追加
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  approvalHistories ApprovalHistory[]
  approvalRequest   ApprovalRequest?
  blocks            DocumentBlock[]
  documentType      DocumentType?     @relation(fields: [document_type_id], references: [id])
  folder            Folder            @relation(fields: [folder_id], references: [id])
  creator           User              @relation("DocumentCreator", fields: [creator_id], references: [id])
  revisionHistories RevisionHistory[]

  @@unique([folder_id, sequence])
  @@map("documents")
}

model DocumentBlock {
  id          Int      @id @default(autoincrement())
  document_id Int
  type        String
  content     String
  position_x  Float
  position_y  Float
  width       Float
  height      Float
  sort_order  Int      @default(0)
  document    Document @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("document_blocks")
}

model ApprovalRequest {
  id           Int       @id @default(autoincrement())
  document_id  Int       @unique
  requester_id Int
  checker_id   Int
  approver_id  Int
  requested_at DateTime  @default(now())
  comment      String?
  checked_at   DateTime?
  approver     User      @relation("ApprovalApprover", fields: [approver_id], references: [id])
  checker      User      @relation("ApprovalChecker", fields: [checker_id], references: [id])
  requester    User      @relation("ApprovalRequester", fields: [requester_id], references: [id])
  document     Document  @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("approval_requests")
}

model ApprovalHistory {
  id          Int      @id @default(autoincrement())
  document_id Int
  user_id     Int
  action      String
  comment     String?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [id])
  document    Document @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("approval_history")
}

model RevisionHistory {
  id                Int       @id @default(autoincrement())
  document_id       Int
  management_number String
  revision_symbol   String
  title             String
  approved_by_id    Int?
  checked_by_id     Int
  created_by_id     Int
  approved_at       DateTime?
  created_at        DateTime  @default(now())
  createdBy         User      @relation("RevisionCreatedBy", fields: [created_by_id], references: [id])
  checkedBy         User      @relation("RevisionCheckedBy", fields: [checked_by_id], references: [id])
  approvedBy        User?     @relation("RevisionApprovedBy", fields: [approved_by_id], references: [id])
  document          Document  @relation(fields: [document_id], references: [id], onDelete: Cascade)

  @@map("revision_history")
}

model Template {
  id         Int      @id @default(autoincrement())
  name       String
  content    String
  created_by Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  creator    User     @relation("TemplateCreator", fields: [created_by], references: [id])

  @@map("templates")
}
